# Kubernetes Ingress for SVB Webstack
# ====================================
# Ingress exposes HTTP routes from outside the cluster to services within.
#
# WHY INGRESS?
# - Single entry point for all traffic
# - Path-based routing (/ -> frontend, /api -> backend)
# - Can add TLS/HTTPS easily
# - More flexible than NodePort
# - Extra points: "scaling of API across nodes using ingress"
#
# PREREQUISITES:
# - NGINX Ingress Controller must be installed
# - For kind: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
#
# USAGE:
#   kubectl apply -f ingress.yaml -n svb-webstack

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: svb-ingress
    namespace: svb-webstack
    labels:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: ingress
    annotations:
        # Ingress class annotation
        # WHY kubernetes.io/ingress.class?
        # - Tells which Ingress controller should handle this
        # - 'traefik' for Traefik Ingress Controller
        kubernetes.io/ingress.class: traefik

        # Traefik entrypoints - enable both HTTP (web) and HTTPS (websecure)
        traefik.ingress.kubernetes.io/router.entrypoints: web
spec:
    # Ingress class name (Kubernetes 1.18+)
    ingressClassName: traefik

    # NOTE: TLS section removed - Traefik serves HTTPS with default certificate
    # For custom certificates, add back tls section with secretName

    # Routing rules
    rules:
        # Rule 1: DuckDNS domain with TLS
        # REPLACE with your DuckDNS domain
        - host: svb-milestone2.duckdns.org
          http:
              paths:
                  # API routes to backend
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-backend
                            port:
                                number: 8000

                  # All other routes to frontend
                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-frontend
                            port:
                                number: 80

        # Rule 2: Localhost fallback (no host restriction)
        # WHY this rule?
        # - Allows access via localhost for local development
        # - Still works even if DuckDNS domain isn't pointing here yet
        - http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-backend
                            port:
                                number: 8000

                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-frontend
                            port:
                                number: 80


# ==============================================================================
# HTTPS INGRESS
# ==============================================================================
# Separate ingress for HTTPS traffic
# Uses Traefik's default self-signed certificate

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: svb-ingress-https
    namespace: svb-webstack
    labels:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: ingress-https
    annotations:
        kubernetes.io/ingress.class: traefik
        # Enable TLS on the websecure entrypoint
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.tls: "true"
        # Use Let's Encrypt certificate resolver
        traefik.ingress.kubernetes.io/router.tls.certresolver: letsencrypt
spec:
    ingressClassName: traefik

    # Routing rules for HTTPS
    rules:
        # Localhost fallback for HTTPS
        - http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-backend
                            port:
                                number: 8000

                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-frontend
                            port:
                                number: 80

        # DuckDNS domain for HTTPS
        - host: svb-milestone2.duckdns.org
          http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-backend
                            port:
                                number: 8000

                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: svb-frontend
                            port:
                                number: 80
