# we gebruiken een pvc voor de database omdat we data neit willen verliezen na een restart
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: svb-database-pvc
    namespace: svb-webstack
    labels:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: database
spec:
    accessModes:
        - ReadWriteOnce

    # we gebruiken 1Gi voor de database omdat dat meer dan voldoende is voor de demo
    resources:
        requests:
            storage: 1Gi

    storageClassName: standard

---

# we gebruiken een statefulset omdat het zorgt voor een pod met consistente identiteit. Dit is perfect voor databases
apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: svb-database
    namespace: svb-webstack
    labels:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: database
spec:
    serviceName: svb-database

    replicas: 1

    selector:
        matchLabels:
            app.kubernetes.io/name: svb-webstack
            app.kubernetes.io/component: database

    template:
        metadata:
            labels:
                app.kubernetes.io/name: svb-webstack
                app.kubernetes.io/component: database
        spec:
            containers:
                - name: postgres
                  image: svb-database:latest
                  imagePullPolicy: Never

                  ports:
                      - containerPort: 5432
                        name: postgres

                  envFrom:
                      - secretRef:
                            name: svb-db-credentials

                  volumeMounts:
                      - name: postgres-data
                        mountPath: /var/lib/postgresql/data
                        subPath: pgdata

                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "512Mi"
                          cpu: "500m"

                  livenessProbe:
                      exec:
                          command:
                              - pg_isready
                              - -U
                              - postgres
                              - -d
                              - webstack
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3

                  readinessProbe:
                      exec:
                          command:
                              - pg_isready
                              - -U
                              - postgres
                              - -d
                              - webstack
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3

            volumes:
                - name: postgres-data
                  persistentVolumeClaim:
                      claimName: svb-database-pvc

---
# We gebruiken een service om de database toegankelijk te maken in de cluster (niet extern)
apiVersion: v1
kind: Service
metadata:
    name: svb-database
    namespace: svb-webstack
    labels:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: database
spec:
    type: ClusterIP

    selector:
        app.kubernetes.io/name: svb-webstack
        app.kubernetes.io/component: database

    ports:
        - port: 5432
          targetPort: 5432
          protocol: TCP
          name: postgres
